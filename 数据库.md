# 数据库原理

## 一、绪论

1. 概念
   
   - 数据
   
   - 数据库
   
   - 数据库管理系统
   
   - 数据库系统
   
   - 他们的关系

2. 数据管理技术的三个阶段：
   
   - 人工管理阶段：没有专门处理数据的软件   
   
   - 文件系统阶段：有专门的数据管理软件（文件系统）
   
   - 数据库系统阶段

3. 数据库系统的特点：
   
   - 数据结构化
   
   - 数据的共享性高、冗余度低且易扩充
   
   - 数据独立性高
   
   - 数据由数据库管理系统统一管理和控制：数据库管理系统必须提供：安全性保护、完整性检查、并发控制、数据库恢复功能

4. 概念
   
   - 数据模型：对现实世界数据特征的抽象，是数据库系统的核心和基础
   
   - 概念模型（信息模型）：按照用户观点对数据和信息建模
   
   - 逻辑模型：按照计算机系统的观点对数据建模，例：层次模型、网状模型、关系模型、面向对象数据模型、对象关系数据模型、半结构化数据模型
   
   - 物理模型：在系统内部或介质上的表示方法存取方法

5. 数据模型的组成要素
   
   - 数据结构
   
   - 数据操纵
   
   - 数据的完整性约束条件

6. 数据库系统的三级模式结构
   
   - 模式
   
   - 外模式
   
   - 内模式

7. 两层映像：保证了数据库系统中的数据能够具有较高的逻辑独立性和物理独立性
   
   - 外模式/模式映像
   
   - 模式/内模式映像

## 二、关系数据库

1. 概念
   
   - 域、基数
   
   - 笛卡尔积、元组、分量
   
   - 关系、目（度）、属性、候选码、主属性、非主属性（非码属性）、主码、全码

2. 关系的三种类型：基本关系（基本表）、查询表、视图

3. 基本关系6条性质

4. 关系模式

5. 关系操作：查询|插入、删除、修改，操作的对象和结果都是集合

6. 查询操作基本操作：选择、投影、并、差、笛卡尔积

7. 关系数据语言
   
   - 关系代数语言
   
   - 关系演算语言
   
   - 双重特点：结构化查询语言（SQL）

8. 关系完整性
   
   - 实体完整性
   
   - 参照完整性
   
   - 用户定义完整性

9. 关系代数 传统集合运算：并、交、差、笛卡尔积

10. 关系代数 专门的关系运算
    
    - 元组的连接、象集
    
    - 选择（限制）
    
    - 投影
    
    - 连接：等值连接、自然连接、非等值连接，悬浮元组、外连接、左外连接、右外连接
    
    - 除运算

## 三、SQL

### （一）概述

1. 目前没有数据库管理系统能支持SQL标准的所有概念和特性
2. 特点
   - 功能综合风格统一
   - 数据操纵高度非过程化
   - 面向集合的操作方式
   - 以统一的语法结构提供多种使用方式
   - 语言简洁易学易用
3. 基本概念
   - 基本表
   - 存储文件
   - 视图

### （二）数据定义

1. 模式、表、视图、索引

   ![](pic/SQL定义.png)

### （三）数据查询

### （四）数据更新



## 六、关系数据理论

### （一）问题

1. 数据冗余度太大
2. 更新异常
3. 插入异常
4. 删除异常

### （二）规范化

1. 数据依赖：函数依赖、多值依赖
2. 码
3. 第一范式1NF：一个关系的所有属性都是不可分的基本数据项
4. 第二范式2NF：每一个非主属性完全依赖于任何一个候选码
5. 第三范式3NF：无传递依赖
6. BCNF：对于每一个X->Y，X是候选码

### （三）数据依赖的公理系统

1. 自反律
2. 增广律
3. 传递律

### （四）保持函数依赖的模式分解



### （五）无损连接的模式分解



## 十、优化

### （一）查询处理

1. 查询处理阶段
   - 查询分析：词法分析、语法分析
   - 查询检查：语义检查和分析、安全性、完整性初步
   - 查询优化：代数优化、物理优化，基于规则、基于代价、基于语义
   - 查询执行

2. 查询优化的一般准则
   - 选择运算尽可能先做
   - 在执行连接操作前对关系适当进行预处理
   - 投影运算和选择运算同时做
   - 将投影运算与其前面或后面的双目运算结合

3. 优化算法
   - 输入：一个关系表达式的语法树
   - 输出：计算该表达式的程序
   - 方法：
     1. 分解选择运算
     2. 通过交换选择运算，将其尽可能移到叶端
     3. 通过交换投影运算，将其尽可能移到叶端
     4. 合并串接的选择和投影，一次执行
     5. 对内节点分组
     6. 生成程序

## 十一、数据库恢复技术

1. 事务
   - 事务(Transaction)是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位
   - 事务是数据库恢复和并发控制的基本单位，逻辑工作单位
   - COMMIT
   - ROLLBACK
   - UNDO

2. ACID
   - 原子性（atomicity）
   - 一致性（consistency）
   - 隔离性（isolation）
   - 持续性（durability ）

3. 概述
   - 故障是不可避免的
   - 影响数据正确性，或破坏数据库
   - 数据库的恢复：把数据库从错误状态恢复到某一已知的正确状态(亦称为一致状态或完整状态)

4. 故障种类
   - 事务内部的故障：数据库可能处于不正确状态，使用UNDO恢复
   - 系统故障：影响正在运行的事物但不破坏数据库，重启恢复
   - 介质故障：破坏数据库，使用其他地方的备份恢复

5. 恢复
   - 恢复操作的基本原理：冗余
   - 建立冗余的方法：数据转储、登记日志文件

6. 数据转储
   - 静态转储
   - 动态转储
   - 海量转储
   - 增量转储

7. 登记日志文件
   - 以记录为单位的日志文件内容
   - 以数据块为单位的日志文件
   - 在动态转储方式中必须建立日志文件，后备副本和日志文件结合起来才能有效地恢复数据库
   - 两条原则：1. 登记的次序严格按并发事务执行的时间次序 2. 必须先写日志文件，后写数据库

## 十二、并发控制

1. 并发的任务
   - 必须先写日志文件，后写数据库
   - 保证事务的隔离性
   - 保证数据库的一致性

2. 并发带来的不一致
   - 丢失修改
   - 脏读
   - 不可重复读
   - 幻读

3. SQL事务的四类隔离级别由低到高
   - 读未提交
   - 读已提交
   - 可重复读
   - 可串行化

4. 封锁
   - 封锁就是事务T在对某个数据对象（例如表、记录等）操作之前，先向系统发出请求，对其加锁。加锁后事务T就对该数据对象有了一定的控制，在事务T释放它的锁之前，其他的事务不能更新或读取此数据对象。
   - 基本封锁类型：排它型锁（exclusive locks，简记为X锁）、共享型锁（share locks，简记为S锁）

5. 封锁协议
   - 在运用X锁和S锁对数据对象加锁时，需要约定一些规则，这些规则为封锁协议（locking protocol）。何时申请X锁或S锁、持锁时间、何时释放

6. 一级封锁协议
   - 事务T在修改数据R之前必须先对其加X锁，直到事务结束才释放。
   - 正常结束（COMMIT）、非正常结束（ROLLBACK）
   - 一级封锁协议可防止丢失修改，并保证事务T是可恢复的。
   - 在一级封锁协议中，如果仅仅是读数据不对其进行修改，是不需要加锁的，所以它不能保证可重复读和脏读。

7. 二级封锁协议
   - 一级封锁协议基础上，增加事务T在读取数据R之前必须先对其加S锁，读完后即可释放S锁。
   - 二级封锁协议可以防止丢失修改和脏读。
   - 在二级封锁协议中，由于读完数据后即可释放S锁，所以它不能保证可重复读。

8. 三级封锁协议
   - 一级封锁协议基础上，增加事务T在读取数据R之前必须先对其加S锁，直到事务结束才释放。
   - 三级封锁协议可防止丢失修改、脏读和不可重复读。

9. 死锁活锁

10. 活锁：先来先服务
11. 死锁
    - 预防：一次封锁法、顺序封锁法
    - 诊断：超时法、事务等待图法
    - 解除死锁

12. 可串行性
13. 两段锁
    - 事务分为两个阶段。第一阶段是获得封锁，也称为扩展阶段。事务可以申请获得任何数据项上的任何类型的锁，但是不能释放任何锁 
    - 第二阶段是释放封锁，也称为收缩阶段。事务可以释放任何数据项上的任何类型的锁，但是不能再申请任何锁
    - 事务遵守两段锁协议是可串行化调度的充分条件，而不是必要条件。
    - 若并发事务都遵守两段锁协议，则对这些事务的任何并发调度策略都是可串行化的

14. 封锁的粒度
